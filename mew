import React, { useState } from 'react';
import { View, Text, TouchableOpacity, SafeAreaView, Image, TextInput } from 'react-native';
import { startSendingCommand, stopSendingCommand, toggleSpeed, sendCommand } from '../services/WiFiService';
import Slider from '@react-native-community/slider'; // Import Slider component


const ControlScreen = () => {
    const [speed, setSpeed] = useState(50); // Default speed set to 50%
    const [isObjectAvoidanceActive, setObjectAvoidanceActive] = useState(false);
    const [isLineFollowerActive, setLineFollowerActive] = useState(false);
    const [isDanceModeActive, setDanceModeActive] = useState(false);
    const [isPowerOn, setPowerOn] = useState(true); // State for power toggle
    const [colorIndex, setColorIndex] = useState(0); // State for current color index
    const [leftServo, setLeftServo] = useState(90); // Default value for left servo
    const [rightServo, setRightServo] = useState(90); // Default value for right servo

    // Array of predefined color hex codes
    const colors = ['#FF5733', '#33FF57', '#3357FF', '#F333FF'];

    const togglePower = () => {
        setPowerOn(!isPowerOn);
        if (isPowerOn) {
            // If turning off, stop all commands
            stopSendingCommand();
            sendCommand('stop_object_avoidance');
            sendCommand('stop_line_follower');
            sendCommand('stop_dance_mode');
            setObjectAvoidanceActive(false);
            setLineFollowerActive(false);
            setDanceModeActive(false);
        }
    };

    const toggleObjectAvoidance = () => {
        if (isObjectAvoidanceActive) {
            sendCommand('stop_object_avoidance');
            setObjectAvoidanceActive(false);
        } else {
            sendCommand('object_avoidance');
            setObjectAvoidanceActive(true);
        }
    };

    const toggleLineFollower = () => {
        if (isLineFollowerActive) {
            sendCommand('stop_line_follower');
            setLineFollowerActive(false);
        } else {
            sendCommand('line_follower');
            setLineFollowerActive(true);
        }
    };

    const toggleDanceMode = () => {
        if (isDanceModeActive) {
            sendCommand('stop_dance_mode');
            setDanceModeActive(false);
        } else {
            sendCommand('dance_mode');
            setDanceModeActive(true);
        }
    };

    const sendColorToESP32 = () => {
        const currentColor = colors[colorIndex];
        // Remove the '#' from the beginning if present
        const cleanedHexColor = currentColor.replace('#', '');
        sendCommand(`set_color=${cleanedHexColor}`);

        // Update color index to the next color
        setColorIndex((prevIndex) => (prevIndex + 1) % colors.length);
    };

    const handleLeftServoChange = (value) => {
        setLeftServo(value);
        sendCommand(`left_servo=${value}`); // Send command for left servo
    };

    const handleRightServoChange = (value) => {
        setRightServo(value);
        sendCommand(`right_servo=${value}`); // Send command for right servo
    };


    return (
        <SafeAreaView className="flex-1 bg-black">
            <View className="flex-1 flex-row justify-center items-center">
                <View className='flex-row justify-around align-middle items-center aspect-auto h-full w-full p-4 bg-gray-600 rounded-3xl'>
                    {/* Left control column with buttons */}
                    <View className="w-1/4 h-1/4 aspect-square bg-zinc-500 border-zinc-600 border-2 p-4 rounded-full items-center justify-center" style={{ opacity: isPowerOn ? 1 : 0.5 }}>
                        {/* Forward Button */}
                        <TouchableOpacity
                            className="absolute justify-center items-center aspect-square rounded-full w-1/3 h-2/3 inset-x-50 top-0"
                            onPressIn={() => isPowerOn && startSendingCommand('forward')}
                            onPressOut={stopSendingCommand}
                            disabled={!isPowerOn}
                        >
                        </TouchableOpacity>

                        {/* Backward Button */}
                        <TouchableOpacity
                            className="absolute justify-center items-center aspect-square rounded-full w-1/3 h-2/3 inset-x-50 bottom-0"
                            onPressIn={() => isPowerOn && startSendingCommand('backward')}
                            onPressOut={stopSendingCommand}
                            disabled={!isPowerOn}
                        >
                            {/* <Text className="text-white text-lg"></Text> */}
                        </TouchableOpacity>

                        {/* Left Button */}
                        <TouchableOpacity
                            className="absolute justify-center items-center aspect-square bg-cyan-200 rounded-full w-2/3 h-1/3 inset-y-50 left-0"
                            onPressIn={() => isPowerOn && startSendingCommand('left')}
                            onPressOut={stopSendingCommand}
                            disabled={!isPowerOn}
                        >
                            <Text className="text-red-500 text-lg"></Text>
                        </TouchableOpacity>

                        {/* Right Button */}
                        <TouchableOpacity
                            className="absolute justify-center items-center aspect-square rounded-full w-2/3 h-1/3 inset-y-50 right-0"
                            onPressIn={() => isPowerOn && startSendingCommand('right')}
                            onPressOut={stopSendingCommand}
                            disabled={!isPowerOn}
                        >
                            <Text className="text-white text-lg"></Text>
                        </TouchableOpacity>

                        {/* Speed Toggle Button */}
                        <TouchableOpacity
                            className="justify-center w-2/5 h-2/5 aspect-square items-center p-3 rounded-full border-4 bg-gray-500 border-zinc-400"
                            onPress={() => isPowerOn && toggleSpeed(speed, setSpeed)}
                            disabled={!isPowerOn}
                        >
                            <Text className="text-white text-base">{speed}%</Text>
                        </TouchableOpacity>
                    </View>

                    {/* Right panel with mode buttons */}
                    <View className="w-1/4 h-1/4 aspect-square border-zinc-600 border-2 p-4 rounded-full items-center justify-center" style={{ opacity: isPowerOn ? 1 : 0.5 }}>
                        <TouchableOpacity
                            className="absolute justify-center items-center aspect-square rounded-full w-1/3 h-1/3 inset-x-50 top-0"
                            style={{ backgroundColor: isObjectAvoidanceActive ? 'green' : 'teal' }}
                            onPress={toggleObjectAvoidance}
                            disabled={!isPowerOn}
                        >
                            {/* <Text className="text-white text-xs">Object Avoidance</Text> */}
                        </TouchableOpacity>

                        <TouchableOpacity
                            className="absolute justify-center items-center aspect-square rounded-full w-1/3 h-1/3 inset-y-50 left-0"
                            style={{ backgroundColor: isLineFollowerActive ? 'orange' : 'teal' }}
                            onPress={toggleLineFollower}
                            disabled={!isPowerOn}
                        >
                            {/* <Text className="text-white text-xs">Line Follower</Text> */}
                        </TouchableOpacity>

                        <TouchableOpacity
                            className="absolute justify-center items-center aspect-square rounded-full w-1/3 h-1/3 inset-y-50 right-0"
                            style={{ backgroundColor: isDanceModeActive ? 'blue' : 'teal' }}
                            onPress={toggleDanceMode}
                            disabled={!isPowerOn}
                        >
                            {/* <Text className="text-white text-xs">Dance Mode</Text> */}
                        </TouchableOpacity>

                        {/* Color Picker Button */}
                        <TouchableOpacity
                            className="mt-2 bg-teal-400 p-2 absolute justify-center items-center aspect-square rounded-full w-1/3 h-1/3 inset-x-50 bottom-0"
                            onPress={sendColorToESP32}
                            disabled={!isPowerOn}
                        >
                            <Text className="text-white">Send Color</Text>
                        </TouchableOpacity>
                    </View>

                </View>
            </View>
            <View className="absolute bottom-16 w-full flex-row justify-around items-center p-4">
                {/* Left Servo Slider */}
                <View className="w-1/3">
                    <Text className="text-white text-center">Left Servo: {leftServo}°</Text>
                    <Slider
                        style={{ width: '100%', height: 40 }}
                        minimumValue={0}
                        maximumValue={180}
                        step={1}
                        value={leftServo}
                        onValueChange={handleLeftServoChange}
                        minimumTrackTintColor="#FFFFFF"
                        maximumTrackTintColor="#000000"
                    />
                </View>

                {/* Right Servo Slider */}
                <View className="w-1/3">
                    <Text className="text-white text-center">Right Servo: {rightServo}°</Text>
                    <Slider
                        style={{ width: '100%', height: 40 }}
                        minimumValue={0}
                        maximumValue={180}
                        step={1}
                        value={rightServo}
                        onValueChange={handleRightServoChange}
                        minimumTrackTintColor="#FFFFFF"
                        maximumTrackTintColor="#000000"
                    />
                </View>
            </View>
            <View className='absolute w-full h-14 bg-gray-700 rounded-t-3xl justify-center items-center'>
                <Image className='left-4 absolute aspect-square h-8 w-8 ' source={require('../public/cropped-Logo_circle-removebg-preview-50x50.png')} />
                <TouchableOpacity
                    className={`h-4 w-14 top-1/2 z-10 rounded ${isPowerOn ? 'bg-teal-400 shadow-lg shadow-green-400/100' : 'bg-red-300 shadow-2xl shadow-red-400/100'}`}
                    onPress={togglePower}
                >
                </TouchableOpacity>
                <View className='bg-transparent border-t-[20px] absolute top-[100%] left-50 w-40 border-l-[40px] h-[100px] border-r-[40px] border-t-gray-700 border-r-transparent border-l-transparent' />
            </View>
            <View className='bg-gray-700 absolute w-full h-14 bottom-0 justify-center items-center rounded-b-3xl'>
                <View className='bg-transparent border-b-[20px] absolute top-[-100] left-50 w-40 border-l-[40px] h-[100px] border-r-[40px] border-b-gray-700 border-r-transparent border-l-transparent' />
            </View>
        </SafeAreaView>
    );
};

export default ControlScreen;
